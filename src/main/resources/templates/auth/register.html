<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout(~{::content})}">
<th:block th:fragment="content">
    <section class="d-flex justify-content-center">
        <div class="card shadow-sm border-0 w-100" style="max-width: 560px;">
            <div class="card-body p-4 p-md-5">
                <h1 class="h4 fw-bold mb-2 text-center">Create Account</h1>
                <p class="text-secondary text-center mb-4">Register to create and manage your AI-powered reviews.</p>

                <form th:action="@{/register}" method="post" th:object="${registrationRequest}"
                      class="d-flex flex-column gap-3">
                    <div th:if="${#fields.hasGlobalErrors()}" class="alert alert-danger" role="alert">
                        <p class="mb-0" th:each="err: ${#fields.globalErrors()}" th:text="${err}"></p>
                    </div>
                    <div class="form-floating">
                        <input id="username" name="username" type="text" class="form-control"
                               placeholder="Username" th:field="*{username}" required
                               th:classappend="${#fields.hasErrors('username')}? ' is-invalid'">
                        <label for="username">Username</label>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('username')}" th:errors="*{username}"></div>
                        <span id="username-msg" class="form-text small"></span>
                    </div>
                    <div class="form-floating">
                        <input id="password" name="password" type="password" class="form-control"
                               placeholder="Password" th:field="*{password}" required
                               th:classappend="${#fields.hasErrors('password')}? ' is-invalid'">
                        <label for="password">Password</label>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('password')}" th:errors="*{password}"></div>
                    </div>
                    <div class="form-floating">
                        <input id="confirmPassword" name="confirmPassword" type="password" class="form-control"
                               placeholder="Confirm Password" th:field="*{confirmPassword}" required
                               th:classappend="${#fields.hasErrors('confirmPassword')}? ' is-invalid'">
                        <label for="confirmPassword">Confirm Password</label>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('confirmPassword')}" th:errors="*{confirmPassword}"></div>
                    </div>
                    <div class="form-floating">
                        <input id="email" name="email" type="email" class="form-control"
                               placeholder="Email (optional)" th:field="*{email}"
                               th:classappend="${#fields.hasErrors('email')}? ' is-invalid'">
                        <label for="email">Email (optional)</label>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('email')}" th:errors="*{email}"></div>
                    </div>
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                    <div class="d-flex justify-content-between align-items-center">
                        <a class="text-secondary" th:href="@{/login}">Already have an account? Sign in</a>
                        <button id="submit-btn" type="submit" class="btn btn-primary px-4" disabled>Register</button>
                    </div>
                </form>
            </div>
        </div>
    </section>
    <script>
        (() => {
            const usernameInput = document.getElementById('username');
            const usernameMsg = document.getElementById('username-msg');
            const submitBtn = document.getElementById('submit-btn');
            const form = document.querySelector('form[method="post"]');

            const cache = new Map();
            let debounceTimer;
            let currentController;
            let usernameOk = false;

            const USERNAME_PATTERN = /^[a-zA-Z0-9_]+$/;

            const setStatus = (message, state) => {
                usernameMsg.textContent = message;
                usernameMsg.classList.remove('text-success', 'text-danger', 'text-muted');
                if (state === 'valid') {
                    usernameMsg.classList.add('text-success');
                } else if (state === 'invalid') {
                    usernameMsg.classList.add('text-danger');
                } else {
                    usernameMsg.classList.add('text-muted');
                }
            };

            const disableSubmit = () => {
                submitBtn.setAttribute('disabled', 'disabled');
                usernameOk = false;
            };

            const enableSubmit = () => {
                submitBtn.removeAttribute('disabled');
                usernameOk = true;
            };

            const preValidate = (value) => {
                if (value.length < 3) {
                    setStatus('Username must be at least 3 characters.', 'invalid');
                    disableSubmit();
                    return false;
                }
                if (!USERNAME_PATTERN.test(value)) {
                    setStatus('Only letters, numbers, and underscores are allowed.', 'invalid');
                    disableSubmit();
                    return false;
                }
                return true;
            };

            const updateAvailability = (isAvailable, reference) => {
                if (usernameInput.value.trim() !== reference) {
                    return;
                }
                if (isAvailable) {
                    setStatus('Username is available.', 'valid');
                    enableSubmit();
                } else {
                    setStatus('Username is already taken.', 'invalid');
                    disableSubmit();
                }
            };

            const checkUsername = async (value) => {
                const trimmed = value.trim();
                if (!preValidate(trimmed)) {
                    return;
                }

                if (cache.has(trimmed)) {
                    updateAvailability(cache.get(trimmed), trimmed);
                    return;
                }

                if (currentController) {
                    currentController.abort();
                }
                currentController = new AbortController();
                setStatus('Checking availability...', 'neutral');

                try {
                    const response = await fetch(`/api/users/check-username?username=${encodeURIComponent(trimmed)}`, {
                        signal: currentController.signal,
                        headers: { 'Accept': 'application/json' }
                    });

                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const data = await response.json();
                    cache.set(trimmed, data.available);
                    updateAvailability(data.available, trimmed);
                } catch (error) {
                    if (error.name === 'AbortError') {
                        return;
                    }
                    setStatus('Unable to verify username right now.', 'invalid');
                    disableSubmit();
                }
            };

            const debounceCheck = (event) => {
                const value = event.target.value;
                disableSubmit();
                setStatus('', 'neutral');

                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => checkUsername(value), 400);
            };

            usernameInput.addEventListener('input', debounceCheck);

            form.addEventListener('submit', (event) => {
                if (!usernameOk) {
                    event.preventDefault();
                    setStatus('Username availability check must pass before submission.', 'invalid');
                    disableSubmit();
                }
            });

            if (usernameInput.value) {
                checkUsername(usernameInput.value);
            } else {
                disableSubmit();
            }
        })();
    </script>
</th:block>
</html>
